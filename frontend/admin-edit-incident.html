<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Incident</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>#map { margin-bottom: 15px; }</style>
</head>
<body>
  <h1>Edit Incident</h1>
  <form id="edit-incident-form" enctype="multipart/form-data">
    <input type="text" name="reporterName" id="reporterName" placeholder="Reporter Name" required />
    <input type="text" name="incidentType" id="incidentType" placeholder="Incident Type" required />
    <textarea name="description" id="description" placeholder="Description" required></textarea>

    <!-- Hidden inputs for location -->
    <input type="hidden" name="location[lat]" id="lat" required />
    <input type="hidden" name="location[lng]" id="lng" required />

    <div id="map"></div>

    <p>Upload new images (optional):</p>
    <input type="file" name="images" multiple accept="image/*" />

    <button type="submit">Save Changes</button>
  </form>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const incidentId = urlParams.get("id");
    if (!incidentId) {
      alert("No incident ID provided");
      window.location.href = "admin.html";
    }

    const form = document.getElementById("edit-incident-form");
    const reporterNameInput = document.getElementById("reporterName");
    const incidentTypeInput = document.getElementById("incidentType");
    const descriptionInput = document.getElementById("description");
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");

    let map, marker;

    async function loadIncident() {
      try {
        const res = await fetch(`/api/incidents/${incidentId}`);
        if (!res.ok) throw new Error("Incident not found");
        const incident = await res.json();

        reporterNameInput.value = incident.reporterName || "";
        incidentTypeInput.value = incident.incidentType || "";
        descriptionInput.value = incident.description || "";

        if (incident.location && incident.location.lat && incident.location.lng) {
          latInput.value = incident.location.lat;
          lngInput.value = incident.location.lng;
          initMap(incident.location.lat, incident.location.lng);
        } else {
          initMap(14.4089, 121.0341); // default coords
        }
      } catch (err) {
        alert("Failed to load incident: " + err.message);
        window.location.href = "admin.html";
      }
    }

    function initMap(lat, lng) {
      map = L.map("map").setView([lat, lng], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      marker = L.marker([lat, lng], { draggable: true }).addTo(map);

      marker.on("dragend", function (e) {
        const pos = e.target.getLatLng();
        latInput.value = pos.lat;
        lngInput.value = pos.lng;
      });

      setTimeout(() => map.invalidateSize(), 0);
      window.addEventListener("resize", () => map.invalidateSize());
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      // Location as JSON string for backend parsing
      formData.set("location", JSON.stringify({
        lat: parseFloat(latInput.value),
        lng: parseFloat(lngInput.value)
      }));

      try {
        const res = await fetch(`/api/incidents/${incidentId}`, {
          method: "PUT",
          body: formData
        });
        const data = await res.json();
        if (res.ok) {
          alert(data.message);
          window.location.href = "admin.html";
        } else {
          alert("Failed to update incident: " + (data.message || ""));
        }
      } catch (err) {
        alert("Error updating incident: " + err.message);
      }
    });

    loadIncident();
  </script>
</body>
</html>
