<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Incident</title>
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>#map { margin-bottom: 15px; }</style>
</head>
<body>
  <nav class="admin-navbar">
    <div class="container">
      <a href="admin.html" class="logo">Admin Dashboard</a>
      <input type="checkbox" id="admin-nav-toggle" class="admin-nav-toggle" aria-label="Toggle navigation" />
      <label for="admin-nav-toggle" class="admin-nav-toggle-label" aria-hidden="true"><span></span></label>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="admin.html">Incidents</a></li>
        <li><a href="admin-news.html">Add News</a></li>
        <li><a href="admin-events.html">Add Events</a></li>
        <li><a href="admin-user-approval.html">User Approvals</a></li>
        <li><a href="#" id="logout-link">Logout</a></li>
      </ul>
      <div class="admin-nav-overlay" tabindex="-1" aria-hidden="true"></div>
    </div>
  </nav>
  <div class="admin-mobile-tabbar" role="navigation" aria-label="Admin Navigation">
    <a href="admin.html" class="tab-link">Incidents</a>
    <a href="admin-news.html" class="tab-link">News</a>
    <a href="admin-events.html" class="tab-link">Events</a>
    <a href="admin-user-approval.html" class="tab-link">Approvals</a>
  </div>
  <div class="container">
    <div class="page-header">
      <h1 class="title">Edit Incident</h1>
      <span id="edit-status-badge" class="status-badge">Pending</span>
    </div>
    <div class="card">
      <div class="card-head">
        <h2 class="card-title">Incident Details</h2>
        <p class="card-desc">Update fields, adjust location, and add images.</p>
      </div>
      <form id="edit-incident-form" enctype="multipart/form-data">
        <div class="form-section">
          <h3>Basic Info</h3>
          <label for="reporterName">Reporter Name</label>
          <input type="text" name="reporterName" id="reporterName" placeholder="Reporter Name" required />

          <label for="incidentType">Incident Type</label>
          <input type="text" name="incidentType" id="incidentType" placeholder="Incident Type" required />

          <label for="description">Description</label>
          <textarea name="description" id="description" placeholder="Description" required></textarea>
        </div>

        <div class="form-section">
          <h3>Status</h3>
          <select name="status" id="status" required>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
        </div>

        <div class="form-section map-card">
          <h3>Location</h3>
          <!-- Hidden inputs for location -->
          <input type="hidden" name="location[lat]" id="lat" required />
          <input type="hidden" name="location[lng]" id="lng" required />
          <div id="map" class="map-wrap"></div>
          <p class="map-help">Drag the pin to refine the exact location.</p>
        </div>

        <div class="form-section">
          <h3>Current Images</h3>
          <div id="current-images" class="image-grid"></div>
        </div>

        <div class="form-section">
          <h3>Upload New Images</h3>
          <div class="file-drop" id="file-drop">
            <span>Drag & drop images here or click to browse</span>
            <button type="button" class="pill-btn">Browse</button>
            <input type="file" name="images" id="images" multiple accept="image/*" style="display:none" />
          </div>
          <div class="file-list" id="file-list"></div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-gradient">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="js/admin-ui.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const incidentId = urlParams.get("id");
    if (!incidentId) {
      alert("No incident ID provided");
      window.location.href = "admin.html";
    }

    const form = document.getElementById("edit-incident-form");
    const reporterNameInput = document.getElementById("reporterName");
    const incidentTypeInput = document.getElementById("incidentType");
    const descriptionInput = document.getElementById("description");
    const statusSelect = document.getElementById("status");
    const statusBadge = document.getElementById("edit-status-badge");
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");
    const imagesInput = document.getElementById("images");
    const fileDrop = document.getElementById("file-drop");
    const fileList = document.getElementById("file-list");
    const currentImages = document.getElementById("current-images");

    let map, marker;

    async function loadIncident() {
      try {
        const res = await fetch(`/api/incidents/${incidentId}`);
        if (!res.ok) throw new Error("Incident not found");
        const incident = await res.json();

        reporterNameInput.value = incident.reporterName || "";
        incidentTypeInput.value = incident.incidentType || "";
        descriptionInput.value = incident.description || "";
        if (incident.status) {
          statusSelect.value = incident.status;
          statusBadge.textContent = incident.status;
        }

        if (incident.location && incident.location.lat && incident.location.lng) {
          latInput.value = incident.location.lat;
          lngInput.value = incident.location.lng;
          initMap(incident.location.lat, incident.location.lng);
        } else {
          initMap(14.4089, 121.0341); // default coords
        }

        // Render current images
        if (Array.isArray(incident.images) && incident.images.length > 0) {
          currentImages.innerHTML = incident.images
            .map(src => `<img src="${src}" alt="incident image">`)
            .join("");
        } else {
          currentImages.innerHTML = "<p class='form-desc'>No images uploaded for this incident.</p>";
        }
      } catch (err) {
        alert("Failed to load incident: " + err.message);
        window.location.href = "admin.html";
      }
    }

    function initMap(lat, lng) {
      map = L.map("map").setView([lat, lng], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      marker = L.marker([lat, lng], { draggable: true }).addTo(map);

      marker.on("dragend", function (e) {
        const pos = e.target.getLatLng();
        latInput.value = pos.lat;
        lngInput.value = pos.lng;
      });

      setTimeout(() => map.invalidateSize(), 0);
      window.addEventListener("resize", () => map.invalidateSize());

      const navToggle = document.getElementById("admin-nav-toggle");
      if (navToggle) {
        navToggle.addEventListener("change", () => setTimeout(() => map.invalidateSize(), 250));
      }
    }

    // File drop interactions
    fileDrop.addEventListener("click", () => imagesInput.click());
    fileDrop.addEventListener("dragover", (e) => {
      e.preventDefault();
      fileDrop.style.background = "#f0f2f5";
    });
    fileDrop.addEventListener("dragleave", () => {
      fileDrop.style.background = "#fff";
    });
    fileDrop.addEventListener("drop", (e) => {
      e.preventDefault();
      fileDrop.style.background = "#fff";
      imagesInput.files = e.dataTransfer.files;
      updateFileList();
    });
    imagesInput.addEventListener("change", updateFileList);
    function updateFileList() {
      const files = Array.from(imagesInput.files || []);
      if (files.length === 0) { fileList.textContent = "No files selected."; return; }
      fileList.innerHTML = files.map(f => `â€¢ ${f.name}`).join("<br>");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      // Location as JSON string for backend parsing
      formData.set("location", JSON.stringify({
        lat: parseFloat(latInput.value),
        lng: parseFloat(lngInput.value)
      }));

      try {
        const res = await fetch(`/api/incidents/${incidentId}`, {
          method: "PUT",
          body: formData
        });
        const data = await res.json();
        if (res.ok) {
          alert(data.message);
          window.location.href = "admin.html";
        } else {
          alert("Failed to update incident: " + (data.message || ""));
        }
      } catch (err) {
        alert("Error updating incident: " + err.message);
      }
    });

    loadIncident();
  </script>
</body>
</html>
