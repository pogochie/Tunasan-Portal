<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barangay Tunasan Incidents</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <h1 data-i18n="incidents.title">Recent Incidents</h1>
  <!-- Heatmap controls -->
  <section class="map-controls" role="region" aria-label="Heatmap controls">
    <div class="col-span-12">
      <strong data-i18n="incidents.heatmapTitle">Heatmap Controls</strong>
    </div>
    <label class="toggle col-span-6">
      <input type="checkbox" id="hm-toggle" checked>
      <span data-i18n="incidents.showHeatmap">Show heatmap</span>
    </label>
    <div class="col-span-6" style="text-align:right;">
      <button id="hm-fit" class="pill-btn" type="button" data-i18n="incidents.fit">Fit to incidents</button>
    </div>
    <div class="col-span-4">
      <label for="hm-radius"><span data-i18n="incidents.radius">Radius</span>: <span id="hm-radius-val">25</span></label>
      <input type="range" id="hm-radius" min="10" max="50" step="1" value="25" aria-labelledby="hm-radius">
    </div>
    <div class="col-span-4">
      <label for="hm-blur"><span data-i18n="incidents.blur">Blur</span>: <span id="hm-blur-val">18</span></label>
      <input type="range" id="hm-blur" min="10" max="40" step="1" value="18" aria-labelledby="hm-blur">
    </div>
    <div class="col-span-4">
      <label for="hm-max"><span data-i18n="incidents.max">Max intensity</span>: <span id="hm-max-val">0.6</span></label>
      <input type="range" id="hm-max" min="0.1" max="1" step="0.1" value="0.6" aria-labelledby="hm-max">
    </div>
  </section>
  <!-- Heatmap container -->
  <div id="heatmap" style="margin: 10px 0; height: 320px;"></div>

  <ul id="incidents-list" class="feed"></ul>

  <script>
    function timeAgo(dateInput) {
      const d = new Date(dateInput);
      const seconds = Math.floor((Date.now() - d.getTime()) / 1000);
      const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });
      const intervals = [
        { s: 60, unit: "second" },
        { s: 3600, unit: "minute" },
        { s: 86400, unit: "hour" },
        { s: 604800, unit: "day" },
        { s: 2592000, unit: "week" },
        { s: 31536000, unit: "month" },
      ];
      let value = -Math.floor(seconds);
      let unit = "second";
      if (seconds >= 31536000) { unit = "year"; value = -Math.floor(seconds / 31536000); }
      else if (seconds >= 2592000) { unit = "month"; value = -Math.floor(seconds / 2592000); }
      else if (seconds >= 604800) { unit = "week"; value = -Math.floor(seconds / 604800); }
      else if (seconds >= 86400) { unit = "day"; value = -Math.floor(seconds / 86400); }
      else if (seconds >= 3600) { unit = "hour"; value = -Math.floor(seconds / 3600); }
      else if (seconds >= 60) { unit = "minute"; value = -Math.floor(seconds / 60); }
      return rtf.format(value, unit);
    }

    function getLikeKey(id) { return `likes_inc_${id}`; }
    function getLikedKey(id) { return `liked_inc_${id}`; }

    function getLikes(id) {
      return parseInt(localStorage.getItem(getLikeKey(id)) || "0", 10);
    }
    function isLiked(id) {
      return localStorage.getItem(getLikedKey(id)) === "true";
    }
    function setLiked(id, liked) {
      localStorage.setItem(getLikedKey(id), liked ? "true" : "false");
      const count = Math.max(0, getLikes(id) + (liked ? 1 : -1));
      localStorage.setItem(getLikeKey(id), String(count));
      return count;
    }

    async function loadIncidents() {
      try {
        const res = await fetch("/api/incidents");
        const incidents = await res.json();
        const approvedIncidents = incidents.filter(i => (i.status || "").toLowerCase() === "approved");
        const incidentsList = document.getElementById("incidents-list");
        incidentsList.innerHTML = "";

        // Geofence banner: find nearby incidents (1 km)
        let userLoc = null;
        if ("geolocation" in navigator) {
          try {
            userLoc = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(
                pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                reject,
                { enableHighAccuracy: true, timeout: 5000 }
              );
            });
          } catch (_) {}
        }
        if (userLoc) {
          const R = 6371e3, toRad = d => (d * Math.PI) / 180;
          const dist = (a, b) => {
            const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
            const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
            const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
            return 2 * R * Math.asin(Math.sqrt(h));
          };
          const nearby = approvedIncidents.filter(i => i.location?.lat && i.location?.lng)
            .map(i => ({ i, d: dist(userLoc, i.location) }))
            .filter(x => x.d <= 1000);
          if (nearby.length > 0) {
            const banner = document.createElement("div");
            banner.className = "post-card";
            banner.innerHTML = `
              <strong data-i18n="incidents.nearbyTitle">Incidents near you</strong>
              <p>${nearby.length} <span data-i18n="incidents.within">incident(s) within 1 km.</span></p>
            `;
            incidentsList.parentNode.insertBefore(banner, incidentsList);
          }
        }

        if (approvedIncidents.length === 0) {
          incidentsList.innerHTML = '<li class="post-card">No recent incidents reported.</li>';
          window.dispatchEvent(new CustomEvent('feed:loaded', { detail: { page: 'incidents', count: 0 } }));
          return;
        }

        // Heatmap with controls
        let map, heat, bounds;
        const radiusEl = document.getElementById("hm-radius");
        const blurEl = document.getElementById("hm-blur");
        const maxEl = document.getElementById("hm-max");
        const toggleEl = document.getElementById("hm-toggle");
        const fitBtn = document.getElementById("hm-fit");

        try {
          map = L.map("heatmap").setView([14.4089, 121.0341], 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
          }).addTo(map);

          const ptsLatLng = approvedIncidents
            .filter(i => i.location?.lat && i.location?.lng)
            .map(i => [i.location.lat, i.location.lng]);
          const pts = ptsLatLng.map(([lat, lng]) => [lat, lng, parseFloat(maxEl.value)]);

          if (ptsLatLng.length > 0) {
            bounds = L.latLngBounds(ptsLatLng);
            map.fitBounds(bounds.pad(0.15));
          }

          if (window.L && L.heatLayer) {
            heat = L.heatLayer(pts, {
              radius: parseInt(radiusEl.value, 10),
              blur: parseInt(blurEl.value, 10),
              maxZoom: 17,
              max: parseFloat(maxEl.value),
            });
            if (toggleEl.checked) heat.addTo(map);
          }

          function updateLabels() {
            document.getElementById("hm-radius-val").textContent = radiusEl.value;
            document.getElementById("hm-blur-val").textContent = blurEl.value;
            document.getElementById("hm-max-val").textContent = parseFloat(maxEl.value).toFixed(1);
          }
          function updateHeat() {
            if (!heat) return;
            heat.setOptions({
              radius: parseInt(radiusEl.value, 10),
              blur: parseInt(blurEl.value, 10),
              max: parseFloat(maxEl.value),
            });
          }
          function toggleHeat() {
            if (!heat) return;
            if (toggleEl.checked) {
              heat.addTo(map);
            } else {
              map.removeLayer(heat);
            }
          }

          radiusEl.addEventListener("input", () => { updateLabels(); updateHeat(); });
          blurEl.addEventListener("input", () => { updateLabels(); updateHeat(); });
          maxEl.addEventListener("input", () => { updateLabels(); updateHeat(); });
          toggleEl.addEventListener("change", toggleHeat);
          fitBtn.addEventListener("click", () => { if (bounds) map.fitBounds(bounds.pad(0.15)); });
          updateLabels();
        } catch (e) { console.warn("Heatmap init failed:", e); }

        approvedIncidents.forEach(incident => {
          const liked = isLiked(incident._id);
          const likeCount = getLikes(incident._id);
          const avatar = `https://i.pravatar.cc/80?u=inc_${incident._id}`;

          const images = (incident.images && incident.images.length > 0)
            ? `
              <div class="post-images ${incident.images.length === 1 ? 'single' : ''}">
                ${incident.images.map(img => `<img src="${img}" loading="lazy" decoding="async" alt="incident image">`).join("")}
              </div>
            `
            : "";

          const li = document.createElement("li");
          li.className = "post-card";
          li.innerHTML = `
            <div class="post-header">
              <img class="avatar" src="${avatar}" alt="Profile">
              <div class="title-wrap">
                <h3>${incident.incidentType}</h3>
                <span class="meta">Reported by ${incident.reporterName} ‚Ä¢ ${timeAgo(incident.createdAt || Date.now())}</span>
              </div>
            </div>
            <div class="post-content">
              <p>${incident.description}</p>
              ${images}
              <p class="location"><small>üìç ${incident.location ? `${incident.location.lat?.toFixed(4)}, ${incident.location.lng?.toFixed(4)}` : 'Location not specified'}</small></p>
            </div>
            <div class="post-actions">
              <div class="like-btn ${liked ? 'liked' : ''}" data-id="${incident._id}">
                <span>üëç</span><span class="like-text">${liked ? 'Liked' : 'Like'}</span>
              </div>
              <div class="like-count" data-id="${incident._id}">${likeCount}</div>
            </div>
          `;
          incidentsList.appendChild(li);
        });

        incidentsList.addEventListener("click", (e) => {
          const btn = e.target.closest(".like-btn");
          if (!btn) return;
          const id = btn.getAttribute("data-id");
          const currentlyLiked = isLiked(id);
          const newCount = setLiked(id, !currentlyLiked);
          btn.classList.toggle("liked", !currentlyLiked);
          btn.querySelector(".like-text").textContent = !currentlyLiked ? "Liked" : "Like";
          const countEl = incidentsList.querySelector(`.like-count[data-id="${id}"]`);
          if (countEl) countEl.textContent = newCount;
        }, { once: true });

        window.dispatchEvent(new CustomEvent('feed:loaded', { detail: { page: 'incidents', count: approvedIncidents.length } }));
      } catch (err) {
        console.error("Failed to load incidents:", err);
      }
    }
    loadIncidents();
  </script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script type="module">
    import { initNavbar } from './js/navbar.js';
    fetch('partials/navbar.html')
      .then(response => response.text())
      .then(data => { document.getElementById('navbar-placeholder').innerHTML = data; initNavbar(); })
      .catch(err => console.error('Failed to load navbar:', err));
  </script>
  <script src="js/i18n.js"></script>
  <script src="js/ui.js"></script>
</body>
</html>