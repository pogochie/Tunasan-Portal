<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barangay Tunasan Incidents</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <br>
  <br>

  <h1 data-i18n="incidents.title">Recent Incidents</h1>

  <!-- Add: Open full-screen map button -->
  <div style="text-align:center; margin: 10px 0 16px;">
    <button id="open-map" class="pill-btn secondary" type="button">Open Incidents Map</button>
  </div>

  <!-- Filters -->
  <section class="filter-controls post-card" role="region" aria-label="Incident filters">
    <div class="filters-grid">
      <label>
        <span>Type</span>
        <select id="filter-type">
          <option value="">All</option>
          <!-- populated dynamically -->
        </select>
      </label>
      <label>
        <span>From</span>
        <input type="date" id="filter-from">
      </label>
      <label>
        <span>To</span>
        <input type="date" id="filter-to">
      </label>
      <button id="filter-clear" class="pill-btn" type="button">Clear</button>
    </div>
  </section>

  <!-- Remove inline heatmap controls and map (now in full-screen modal) -->
  <!--
  <section class="map-controls" role="region" aria-label="Heatmap controls">
    <div class="col-span-12">
      <strong data-i18n="incidents.heatmapTitle">Heatmap Controls</strong>
    </div>
    <label class="toggle col-span-6">
      <input type="checkbox" id="hm-toggle" checked>
      <span data-i18n="incidents.showHeatmap">Show heatmap</span>
    </label>
    <div class="col-span-6" style="text-align:right;">
      <button id="hm-fit" class="pill-btn" type="button" data-i18n="incidents.fit">Fit to incidents</button>
    </div>
    <div class="col-span-4">
      <label for="hm-radius"><span data-i18n="incidents.radius">Radius</span>: <span id="hm-radius-val">25</span></label>
      <input type="range" id="hm-radius" min="10" max="50" step="1" value="25" aria-labelledby="hm-radius">
    </div>
    <div class="col-span-4">
      <label for="hm-blur"><span data-i18n="incidents.blur">Blur</span>: <span id="hm-blur-val">18</span></label>
      <input type="range" id="hm-blur" min="10" max="40" step="1" value="18" aria-labelledby="hm-blur">
    </div>
    <div class="col-span-4">
      <label for="hm-max"><span data-i18n="incidents.max">Max intensity</span>: <span id="hm-max-val">0.6</span></label>
      <input type="range" id="hm-max" min="0.1" max="1" step="0.1" value="0.6" aria-labelledby="hm-max">
    </div>
  </section>
  -->

  <!-- New: Full-screen Map Modal -->
  <div id="map-modal" class="map-modal" aria-hidden="true">
    <div id="map-screen" class="map-canvas" role="region" aria-label="Incidents map"></div>

    <!-- Overlay header with Close button -->
    <header class="map-header">
      <h2>Incidents Map</h2>
      <button id="close-map" class="map-close" aria-label="Close">&times;</button>
    </header>

    <!-- Optional: small legend chips for incident types -->
    <div id="map-legend" class="map-legend" aria-live="polite"></div>

    <!-- Floating Locate button -->
    <button id="locate-me" class="map-fab" type="button" title="Locate me" aria-label="Locate me">ğŸ“</button>

    <!-- NEW: Floating info card for selected incident -->
    <div id="map-info" class="map-info-card" hidden>
      <button id="map-info-close" class="map-info-close" aria-label="Close">&times;</button>
      <div class="map-info-body">
        <div class="map-info-title">
          <span id="map-info-type" class="chip"></span>
          <strong id="map-info-heading"></strong>
        </div>
        <p id="map-info-desc"></p>
        <p id="map-info-meta" class="muted"></p>
        <p id="map-info-loc" class="muted"></p>
      </div>
    </div>
  </div>

  <ul id="incidents-list" class="feed"></ul>

  <!-- Ensure Leaflet JS and heat plugin load BEFORE using L in the script below -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    let INCIDENTS = []; // cache approved incidents for filtering

    // Map modal state
    let map = null, heat = null, bounds = null, userMarker = null, userCircle = null, markersLayer = null;

    function timeAgo(dateInput) {
      const d = new Date(dateInput);
      const seconds = Math.floor((Date.now() - d.getTime()) / 1000);
      const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });
      let unit = "second", value = -Math.floor(seconds);
      if (seconds >= 31536000) { unit = "year"; value = -Math.floor(seconds / 31536000); }
      else if (seconds >= 2592000) { unit = "month"; value = -Math.floor(seconds / 2592000); }
      else if (seconds >= 604800) { unit = "week"; value = -Math.floor(seconds / 604800); }
      else if (seconds >= 86400) { unit = "day"; value = -Math.floor(seconds / 86400); }
      else if (seconds >= 3600) { unit = "hour"; value = -Math.floor(seconds / 3600); }
      else if (seconds >= 60) { unit = "minute"; value = -Math.floor(seconds / 60); }
      return rtf.format(value, unit);
    }

    function getLikeKey(id) { return `likes_inc_${id}`; }
    function getLikedKey(id) { return `liked_inc_${id}`; }
    function getLikes(id) { return parseInt(localStorage.getItem(getLikeKey(id)) || "0", 10); }
    function isLiked(id) { return localStorage.getItem(getLikedKey(id)) === "true"; }
    function setLiked(id, liked) {
      localStorage.setItem(getLikedKey(id), liked ? "true" : "false");
      const count = Math.max(0, getLikes(id) + (liked ? 1 : -1));
      localStorage.setItem(getLikeKey(id), String(count));
      return count;
    }

    function applyFilters() {
      const type = document.getElementById("filter-type").value;
      const from = document.getElementById("filter-from").value;
      const to = document.getElementById("filter-to").value;
      const fromTs = from ? new Date(from).getTime() : null;
      const toTs = to ? new Date(to).getTime() + 86400000 - 1 : null;
      return INCIDENTS.filter(i => {
        const okType = !type || (i.incidentType || "").toLowerCase() === type.toLowerCase();
        const ts = new Date(i.createdAt || Date.now()).getTime();
        const okFrom = !fromTs || ts >= fromTs;
        const okTo = !toTs || ts <= toTs;
        return okType && okFrom && okTo;
      });
    }

    function renderIncidents(list) {
      const container = document.getElementById("incidents-list");
      container.innerHTML = "";
      if (list.length === 0) {
        container.innerHTML = '<li class="post-card">No matching incidents.</li>';
        return;
      }
      list.forEach(incident => {
        const liked = isLiked(incident._id);
        const likeCount = getLikes(incident._id);
        const avatar = `https://i.pravatar.cc/80?u=inc_${incident._id}`;
        const saved = localStorage.getItem(`saved_inc_${incident._id}`) === "true";
        const images = (incident.images && incident.images.length > 0)
          ? `
            <div class="post-images ${incident.images.length === 1 ? 'single' : ''}">
              ${incident.images.map(img => `<img src="${img}" loading="lazy" decoding="async" alt="incident image">`).join("")}
            </div>
          ` : "";
        const li = document.createElement("li");
        li.className = "post-card";
        const link = `${location.origin}/incidents.html#${incident._id}`;
        li.innerHTML = `
          <div class="post-header">
            <img class="avatar" src="${avatar}" alt="Profile">
            <div class="title-wrap">
              <h3>${incident.incidentType}</h3>
              <span class="meta">Reported by ${incident.reporterName} â€¢ ${timeAgo(incident.createdAt || Date.now())}</span>
            </div>
          </div>
          <div class="post-content">
            <p>${incident.description}</p>
            ${images}
            <p class="location"><small>ğŸ“ ${incident.location ? `${incident.location.lat?.toFixed(4)}, ${incident.location.lng?.toFixed(4)}` : 'Location not specified'}</small></p>
          </div>
          <div class="post-actions">
            <div class="action-group">
              <button class="icon-btn save-btn ${saved ? 'active' : ''}" data-id="${incident._id}" title="Save">â­</button>
              <button class="icon-btn share-btn" data-link="${link}" title="Share">ğŸ”—</button>
            </div>
            <div class="like-btn ${liked ? 'liked' : ''}" data-id="${incident._id}">
              <span>ğŸ‘</span><span class="like-text">${liked ? 'Liked' : 'Like'}</span>
            </div>
            <div class="like-count" data-id="${incident._id}">${likeCount}</div>
          </div>
        `;
        container.appendChild(li);
      });
    }

    // Full-screen map helpers
    function buildMap() {
      if (map || !window.L) return;
      map = L.map("map-screen").setView([14.4089, 121.0341], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map);
    }

    function updateLegend(incidents) {
      const legend = document.getElementById("map-legend");
      if (!legend) return;
      const counts = incidents.reduce((acc, i) => {
        const k = (i.incidentType || 'Unknown').trim();
        acc[k] = (acc[k] || 0) + 1; return acc;
      }, {});
      const entries = Object.entries(counts).sort((a,b) => b[1]-a[1]);
      legend.innerHTML = entries.length ? entries.map(([t,c]) => `<span class="chip">${t}: ${c}</span>`).join('') : '';
    }

    // NEW: add labeled markers with type chip + info card on click
    function setMarkers(incidents) {
      if (!map || !window.L) return;
      if (markersLayer) { map.removeLayer(markersLayer); markersLayer = null; }
      markersLayer = L.layerGroup().addTo(map);

      const info = document.getElementById('map-info');
      const infoClose = document.getElementById('map-info-close');
      const setInfo = (i) => {
        if (!info) return;
        document.getElementById('map-info-type').textContent = i.incidentType || 'Unknown';
        document.getElementById('map-info-heading').textContent = i.incidentType || 'Incident';
        document.getElementById('map-info-desc').textContent = i.description || '';
        document.getElementById('map-info-meta').textContent = `Reported by ${i.reporterName || 'Unknown'} â€¢ ${timeAgo(i.createdAt || Date.now())}`;
        const locTxt = i.location?.lat && i.location?.lng
          ? `${i.location.lat.toFixed(5)}, ${i.location.lng.toFixed(5)}`
          : 'Location not specified';
        document.getElementById('map-info-loc').textContent = `ğŸ“ ${locTxt}`;
        info.hidden = false;
      };
      infoClose?.addEventListener('click', () => { info.hidden = true; });

      incidents.forEach(i => {
        if (!(i.location?.lat && i.location?.lng)) return;
        const type = (i.incidentType || 'Unknown');
        const icon = L.divIcon({
          className: 'type-marker',
          html: `<span class="type-chip">${type}</span>`,
          iconSize: [0,0],
        });
        const m = L.marker([i.location.lat, i.location.lng], { icon, zIndexOffset: 500 });
        m.on('click', () => setInfo(i));
        m.addTo(markersLayer);
      });
    }

    function setHeatData(incidents) {
      if (!map || !window.L) return;

      const defaultRadius = parseInt(document.getElementById("hm-radius")?.value || "25", 10);
      const defaultBlur = parseInt(document.getElementById("hm-blur")?.value || "18", 10);
      const defaultMax = parseFloat(document.getElementById("hm-max")?.value || "0.6");
      const showHeat = document.getElementById("hm-toggle") ? document.getElementById("hm-toggle").checked : true;

      const ptsLatLng = incidents
        .filter(i => i.location?.lat && i.location?.lng)
        .map(i => [i.location.lat, i.location.lng]);
      const pts = ptsLatLng.map(([lat, lng]) => [lat, lng, defaultMax]);

      bounds = ptsLatLng.length ? L.latLngBounds(ptsLatLng) : null;
      if (bounds) { map.fitBounds(bounds.pad(0.15)); }

      if (window.L && L.heatLayer) {
        if (!heat) {
          heat = L.heatLayer(pts, {
            radius: defaultRadius,
            blur: defaultBlur,
            maxZoom: 17,
            max: defaultMax,
          });
        } else {
          heat.setLatLngs(pts);
          heat.setOptions({ radius: defaultRadius, blur: defaultBlur, max: defaultMax });
        }
        if (showHeat && !map.hasLayer(heat)) heat.addTo(map);
        if (!showHeat && map.hasLayer(heat)) map.removeLayer(heat);
      }

      // NEW: also place labeled markers
      setMarkers(incidents);

      updateLegend(incidents);
      setTimeout(() => { try { map.invalidateSize(); } catch(_) {} }, 50);
    }

    function openMapModal() {
      const modal = document.getElementById("map-modal");
      if (!modal) return;
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.classList.add("modal-open");
      buildMap();
      setHeatData(applyFilters());
    }

    function closeMapModal() {
      const modal = document.getElementById("map-modal");
      if (!modal) return;
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    }

    function attachModalButtons() {
      const openBtn = document.getElementById("open-map");
      const closeBtn = document.getElementById("close-map");

      openBtn?.addEventListener("click", openMapModal);
      closeBtn?.addEventListener("click", closeMapModal);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && document.getElementById("map-modal")?.classList.contains("open")) {
          closeMapModal();
        }
      });

      // Locate me FAB
      document.getElementById("locate-me")?.addEventListener("click", async () => {
        if (!navigator.geolocation || !map) return;
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 8000 });
          });
          const latlng = [pos.coords.latitude, pos.coords.longitude];
          if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
          if (userCircle) { map.removeLayer(userCircle); userCircle = null; }
          userMarker = L.marker(latlng).addTo(map).bindPopup("You are here").openPopup();
          userCircle = L.circle(latlng, { radius: Math.max(30, pos.coords.accuracy || 30), color: "#1877F2", fillColor: "#1877F2", fillOpacity: 0.15 }).addTo(map);
          map.setView(latlng, 16, { animate: true });
        } catch (err) {
          console.warn("Geolocation failed:", err);
        }
      });
    }

    async function loadIncidents() {
      try {
        const res = await fetch("/api/incidents");
        const incidents = await res.json();
        const approvedIncidents = incidents.filter(i => (i.status || "").toLowerCase() === "approved");
        const incidentsList = document.getElementById("incidents-list");
        incidentsList.innerHTML = "";
        INCIDENTS = approvedIncidents;
        initFilterUI(approvedIncidents.map(i => i.incidentType));
        renderIncidents(approvedIncidents);

        // Geofence banner (unchanged)
        let userLoc = null;
        if ("geolocation" in navigator) {
          try {
            userLoc = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(
                pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                reject,
                { enableHighAccuracy: true, timeout: 5000 }
              );
            });
          } catch (_) {}
        }
        if (userLoc) {
          const R = 6371e3, toRad = d => (d * Math.PI) / 180;
          const dist = (a, b) => {
            const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
            const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
            const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
            return 2 * R * Math.asin(Math.sqrt(h));
          };
          const nearby = approvedIncidents.filter(i => i.location?.lat && i.location?.lng)
            .map(i => ({ i, d: dist(userLoc, i.location) }))
            .filter(x => x.d <= 1000);
          if (nearby.length > 0) {
            const banner = document.createElement("div");
            banner.className = "post-card";
            banner.innerHTML = `
              <strong data-i18n="incidents.nearbyTitle">Incidents near you</strong>
              <p>${nearby.length} <span data-i18n="incidents.within">incident(s) within 1 km.</span></p>
            `;
            incidentsList.parentNode.insertBefore(banner, incidentsList);
          }
        }

        if (approvedIncidents.length === 0) {
          incidentsList.innerHTML = '<li class="post-card">No recent incidents reported.</li>';
          window.dispatchEvent(new CustomEvent('feed:loaded', { detail: { page: 'incidents', count: 0 } }));
          attachModalButtons();
          return;
        }

        // Attach modal open/close and locate handlers
        attachModalButtons();

        window.dispatchEvent(new CustomEvent('feed:loaded', { detail: { page: 'incidents', count: approvedIncidents.length } }));
      } catch (err) {
        console.error("Failed to load incidents:", err);
      }
    }

    // Init filter UI (kept from earlier)
    function initFilterUI(types) {
      const select = document.getElementById("filter-type");
      const unique = Array.from(new Set(types.map(t => (t || "").trim()).filter(Boolean))).sort();
      unique.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t; opt.textContent = t;
        select.appendChild(opt);
      });
      const rerender = () => renderIncidents(applyFilters());
      select.addEventListener("change", rerender);
      document.getElementById("filter-from").addEventListener("change", rerender);
      document.getElementById("filter-to").addEventListener("change", rerender);
      document.getElementById("filter-clear").addEventListener("click", () => {
        select.value = ""; document.getElementById("filter-from").value = "";
        document.getElementById("filter-to").value = ""; rerender();
      });
    }

    // Event delegation for like/save/share (unchanged)
    document.addEventListener("click", (e) => {
      const list = document.getElementById("incidents-list");
      if (!list) return;
      const btn = e.target.closest(".like-btn");
      if (!btn) {
        const saveBtn = e.target.closest(".save-btn");
        if (saveBtn) {
          const id = saveBtn.getAttribute("data-id");
          const curr = localStorage.getItem(`saved_inc_${id}`) === "true";
          localStorage.setItem(`saved_inc_${id}`, (!curr).toString());
          saveBtn.classList.toggle("active", !curr);
          return;
        }
        const shareBtn = e.target.closest(".share-btn");
        if (shareBtn) {
          const link = shareBtn.getAttribute("data-link");
          if (navigator.share) {
            navigator.share({ title: "Incident", url: link }).catch(()=>{});
          } else {
            navigator.clipboard?.writeText(link);
            shareBtn.textContent = "âœ…";
            setTimeout(() => shareBtn.textContent = "ğŸ”—", 1200);
          }
        }
        return;
      }
      const id = btn.getAttribute("data-id");
      const currentlyLiked = isLiked(id);
      const newCount = setLiked(id, !currentlyLiked);
      btn.classList.toggle("liked", !currentlyLiked);
      btn.querySelector(".like-text").textContent = !currentlyLiked ? "Liked" : "Like";
      const countEl = list.querySelector(`.like-count[data-id="${id}"]`);
      if (countEl) countEl.textContent = newCount;
    });

    // Run after Leaflet is available
    if (window.L) loadIncidents();
    else window.addEventListener("load", loadIncidents);
  </script>
  <script type="module">
    import { initNavbar } from './js/navbar.js';
    fetch('partials/navbar.html')
      .then(response => response.text())
      .then(data => { document.getElementById('navbar-placeholder').innerHTML = data; initNavbar(); })
      .catch(err => console.error('Failed to load navbar:', err));
  </script>
  <script src="js/i18n.js"></script>
  <script src="js/ui.js"></script>
  <!-- Heatmap container removed (use fullscreen #map-screen instead) -->
  <!-- <div id="heatmap" style="margin: 10px 0; height: 320px;"></div> -->
</body>
</html>