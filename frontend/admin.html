<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - Barangay Tunasan</title>
  <link rel="stylesheet" href="css/admin.css">
  <!-- Chart.js for statistics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .loading-state {
      text-align: center;
      padding: 20px;
    }
    .error-state {
      color: #dc3545;
      background: #f8d7da;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
  </style>
</head>
<body class="admin-body">
  <nav class="admin-navbar">
    <div class="admin-container">
      <a href="admin.html" class="logo">Barangay Tunasan Admin</a>
      <ul class="admin-nav-menu">
        <li><a href="admin.html">Dashboard</a></li>
        <li><a href="admin-incidents.html">Incidents</a></li>
        <li><a href="admin-news.html">News</a></li>
        <li><a href="admin-events.html">Events</a></li>
        <li><a href="admin-user-approval.html">Users</a></li>
        <li><a href="#" id="logout-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <main class="admin-container">
    <h1>Dashboard Overview</h1>
    
    <!-- Stats Cards -->
    <div class="admin-stats-grid">
      <div class="stat-card">
        <div class="label">Total Incidents</div>
        <div class="value" id="total-incidents">0</div>
        <div class="trend" id="incident-trend"></div>
      </div>
      <div class="stat-card">
        <div class="label">Pending Approval</div>
        <div class="value" id="pending-incidents">0</div>
        <a href="admin-incidents.html?filter=pending">View All</a>
      </div>
      <div class="stat-card">
        <div class="label">Active News</div>
        <div class="value" id="total-news">0</div>
        <a href="admin-news.html">Manage</a>
      </div>
      <div class="stat-card">
        <div class="label">Upcoming Events</div>
        <div class="value" id="upcoming-events">0</div>
        <a href="admin-events.html">View All</a>
      </div>
      <div class="stat-card">
        <div class="label">New Users</div>
        <div class="value" id="new-users">0</div>
        <a href="admin-user-approval.html">Approve</a>
      </div>
      <div class="stat-card">
        <div class="label">Resolved Cases</div>
        <div class="value" id="resolved-cases">0</div>
        <div class="trend" id="resolved-trend"></div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Monthly Statistics</h2>
        <select id="time-period" class="admin-select">
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="365">Last Year</option>
        </select>
      </div>
      <div class="chart-row">
        <div class="chart-container">
          <canvas id="incidents-chart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="status-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Recent Activity</h2>
        <a href="#" class="btn-secondary">View All</a>
      </div>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Description</th>
            <th>User</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recent-activity">
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Quick Actions -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Quick Actions</h2>
      </div>
      <div class="quick-actions">
        <a href="admin-news.html?action=create" class="btn-primary">Create News Post</a>
        <a href="admin-events.html?action=create" class="btn-primary">Create Event</a>
        <a href="admin-incidents.html" class="btn-secondary">Review Incidents</a>
        <a href="admin-user-approval.html" class="btn-secondary">Approve Users</a>
      </div>
    </div>
  </main>

  <script>
    // Check admin login status
    if (localStorage.getItem('adminLoggedIn') !== 'true') {
      window.location.href = 'admin-login.html';
    }

    // Show loading state
    function showLoading() {
      document.getElementById('recent-activity').innerHTML = `
        <tr>
          <td colspan="5" class="loading-state">Loading data...</td>
        </tr>
      `;
      document.querySelectorAll('.value').forEach(el => {
        el.textContent = '--';
      });
    }

    // Show error state
    function showError(message) {
      document.getElementById('recent-activity').innerHTML = `
        <tr>
          <td colspan="5" class="error-state">${message}</td>
        </tr>
      `;
    }

    // Logout functionality
    document.getElementById('logout-link').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('adminLoggedIn');
      window.location.href = 'admin-login.html';
    });

    // Load dashboard data
    async function loadDashboardData() {
      showLoading();
      
      try {
        const response = await fetch('/api/admin/dashboard');
        
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}`);
        }
        
        const data = await response.json();
        
        // Check if data structure is valid
        if (!data || typeof data !== 'object') {
          throw new Error('Invalid data format received');
        }

        // Update stats cards with fallback values
        document.getElementById('total-incidents').textContent = 
          data.incidents?.total ?? 0;
        document.getElementById('pending-incidents').textContent = 
          data.incidents?.pending ?? 0;
        document.getElementById('total-news').textContent = 
          data.news?.total ?? 0;
        document.getElementById('upcoming-events').textContent = 
          data.events?.upcoming ?? 0;
        document.getElementById('new-users').textContent = 
          data.users?.new ?? 0;
        document.getElementById('resolved-cases').textContent = 
          data.incidents?.resolved ?? 0;

        // Update recent activity with fallback
        const activityTable = document.getElementById('recent-activity');
        if (data.recentActivity?.length > 0) {
          activityTable.innerHTML = data.recentActivity.map(item => `
            <tr>
              <td>${item.type || 'N/A'}</td>
              <td>${item.description || 'No description'}</td>
              <td>${item.user || 'System'}</td>
              <td>${item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A'}</td>
              <td><a href="${item.link || '#'}" class="btn-secondary">View</a></td>
            </tr>
          `).join('');
        } else {
          activityTable.innerHTML = `
            <tr>
              <td colspan="5">No recent activity found</td>
            </tr>
          `;
        }

        // Initialize charts if data exists
        if (data.charts) {
          initCharts(data.charts);
        } else {
          console.warn('No chart data received');
        }
        
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showError(`Failed to load data: ${error.message}`);
        
        // Initialize empty charts
        initCharts({
          incidentsOverTime: { labels: [], data: [] },
          statusDistribution: { labels: [], data: [] }
        });
      }
    }

    function initCharts(chartData) {
      // Destroy existing charts if they exist
      if (window.incidentsChart) {
        window.incidentsChart.destroy();
      }
      if (window.statusChart) {
        window.statusChart.destroy();
      }

      // Incidents over time chart
      const incidentsCtx = document.getElementById('incidents-chart').getContext('2d');
      window.incidentsChart = new Chart(incidentsCtx, {
        type: 'line',
        data: {
          labels: chartData.incidentsOverTime?.labels || [],
          datasets: [{
            label: 'Incidents Reported',
            data: chartData.incidentsOverTime?.data || [],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Status distribution chart
      const statusCtx = document.getElementById('status-chart').getContext('2d');
      window.statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: chartData.statusDistribution?.labels || ['No Data'],
          datasets: [{
            data: chartData.statusDistribution?.data || [1],
            backgroundColor: [
              '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Time period selector
    document.getElementById('time-period').addEventListener('change', (e) => {
      loadDashboardData();
    });

    // Initial load
    loadDashboardData();
  </script>
</body>
</html>
