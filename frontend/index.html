<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barangay Tunasan Portal</title>
  <link rel="stylesheet" href="css/style.css" />
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
/>
  <style>
    .hero {
      text-align: center;
      padding: 40px 20px;
      margin-bottom: 30px;
      justify-content: center;
    }
    .hero h1 {
      font-size: 2rem;
      margin-bottom: 15px;
    }
  </style>
  <style>
    /* Center the report form section vertically and horizontally */
    .hero {
      text-align: center;
      padding: 40px 20px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .hero h1 {
      font-size: 2rem;
      margin-bottom: 15px;
    }
    .qr-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 1rem;
}

#qr-code {
  border-radius: 12px;
  background: #fff;
  padding: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}
  </style>
  <style>
    /* FEATURES SECTION */
.features {
  padding: 4rem 0 3rem;
}

.section-title {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 0.5rem;
  color: #080000;
}

/* SWIPE INDICATOR */
.swipe-indicator {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.85rem;
  letter-spacing: 0.05em;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 1.2rem;
  animation: swipeHint 1.6s ease-in-out infinite;
}

@keyframes swipeHint {
  0% { transform: translateX(0); opacity: 0.4; }
  50% { transform: translateX(6px); opacity: 1; }
  100% { transform: translateX(0); opacity: 0.4; }
}

/* SLIDER */
.features-slider {
  display: flex;
  gap: 1.25rem;
  padding: 0 1.25rem 1rem;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}

.features-slider::-webkit-scrollbar {
  display: none;
}

/* CARD */
.feature-card {
  flex: 0 0 260px;
  scroll-snap-align: start;
  
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 2rem 1.5rem;
  text-align: center;

  color: #fff;
  backdrop-filter: blur(12px);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.feature-card i {
  font-size: 2.4rem;
  color: #4fc3f7;
  margin-bottom: 1rem;
}

.feature-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.35);
}
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <main class="container">
    <section class="hero">
      <h1 data-i18n="home.title">Welcome to Barangay Tunasan</h1>
    </section>
    <div class="qr-container">
        <canvas id="qr-code" width="160" height="160" aria-label="QR code to open portal"></canvas>
      </div>

    <section class="features">
  <h2 class="section-title">What You Can Do</h2>

  <div class="swipe-indicator" id="swipeIndicator">
    <span>Swipe</span>
    <i class="fa-solid fa-arrow-right"></i>
  </div>

  <div class="features-slider">
    <div class="feature-card">
      <i class="fa-solid fa-bullhorn"></i>
      <h3>Report Incidents</h3>
      <p>Submit community issues with images and map location.</p>
    </div>

    <div class="feature-card">
      <i class="fa-solid fa-map-location-dot"></i>
      <h3>Pin Location</h3>
      <p>Select exact incident location using the interactive map.</p>
    </div>

    <div class="feature-card">
      <i class="fa-solid fa-newspaper"></i>
      <h3>Barangay News</h3>
      <p>View verified announcements and official updates.</p>
    </div>

    <div class="feature-card">
      <i class="fa-solid fa-qrcode"></i>
      <h3>QR Access</h3>
      <p>Scan QR codes to instantly open the report form.</p>
    </div>
  </div>
</section>




     <h2>Recent Community Activity</h2>
    <section class="community-updates">
      
      <ul id="home-feed" class="feed"></ul>
    </section>
  </main>

  <!-- Modal container wrapping the report form -->
  <div id="report-modal" aria-hidden="true" role="dialog" aria-modal="true">
     <section class="report-section" id="report-section" aria-label="Report an Incident" style="
      max-height: 90vh;
      overflow-y: auto;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      padding: 24px;
      width: 90%;
      max-width: 600px;
      position: relative;
    ">
      <button id="close-report" aria-label="Close report form" style="
        position: absolute;
        top: 12px;
        right: 12px;
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--muted);
      ">√ó</button>

      <!-- Full incident form -->
      <form id="incident-form" enctype="multipart/form-data" novalidate>
        <h2 data-i18n="home.reportTitle">Report an Incident</h2>

        <label for="reporterName">Your Name</label>
        <input type="text" id="reporterName" name="reporterName" placeholder="Your Name" required data-i18n-placeholder="form.name" autocomplete="name" />

        <label for="incidentType">Incident Type</label>
        <input list="incident-types" id="incidentType" name="incidentType" placeholder="Select or type incident type" required data-i18n-placeholder="form.type" autocomplete="off" />
        <datalist id="incident-types">
          <option value="Theft"></option>
          <option value="Vandalism"></option>
          <option value="Noise Complaint"></option>
          <option value="Illegal Dumping"></option>
          <option value="Traffic Accident"></option>
          <option value="Fire"></option>
          <option value="Flood"></option>
          <option value="Other"></option>
        </datalist>
        <!-- Mobile fallback: shown on iOS/unsupported datalist -->
        <select id="incidentTypeSelect" aria-label="Incident Type (mobile fallback)" style="display:none">
          <option value="">Select Incident Type</option>
          <option value="Theft">Theft</option>
          <option value="Vandalism">Vandalism</option>
          <option value="Noise Complaint">Noise Complaint</option>
          <option value="Illegal Dumping">Illegal Dumping</option>
          <option value="Traffic Accident">Traffic Accident</option>
          <option value="Fire">Fire</option>
          <option value="Flood">Flood</option>
          <option value="Other">Other</option>
        </select>

        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Description" required data-i18n-placeholder="form.description" rows="4"></textarea>

        <!-- Hidden inputs for lat/lng -->
        <input type="hidden" name="location[lat]" id="lat" required />
        <input type="hidden" name="location[lng]" id="lng" required />

        <!-- Map container -->
        <div id="map" style="margin-bottom: 15px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); height: 300px;"></div>

        <button type="button" id="geo-btn" class="pill-btn" style="margin-bottom:10px;">Use my location</button>

        <label for="images" style="display: block; margin-bottom: 6px; font-weight: 600;">Upload Images (optional)</label>
        <input type="file" id="images" name="images" multiple accept="image/*" data-i18n-attr="aria-label:form.images" style="margin-bottom: 15px;" />

        <button type="submit" class="pill-btn secondary" style="width: 100%; font-size: 1.1rem; padding: 14px;">Submit Report</button>
      </form>
    </section>
  </div>

  <!-- Floating Report Incident button -->
  <button id="report-btn" class="pill-btn secondary" aria-label="Report an Incident" style="
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1100;
    padding: 14px 20px;
    font-size: 1rem;
    border-radius: 9999px;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
  ">
    Report Incident
  </button>

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <script src="js/main.js"></script>

  <!-- Mini feed loader -->
  <script>
    function timeAgo(dateInput) {
      const d = new Date(dateInput);
      const seconds = Math.floor((Date.now() - d.getTime()) / 1000);
      const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });
      let unit = "second", value = -Math.floor(seconds);
      if (seconds >= 31536000) { unit = "year"; value = -Math.floor(seconds / 31536000); }
      else if (seconds >= 2592000) { unit = "month"; value = -Math.floor(seconds / 2592000); }
      else if (seconds >= 604800) { unit = "week"; value = -Math.floor(seconds / 604800); }
      else if (seconds >= 86400) { unit = "day"; value = -Math.floor(seconds / 86400); }
      else if (seconds >= 3600) { unit = "hour"; value = -Math.floor(seconds / 3600); }
      else if (seconds >= 60) { unit = "minute"; value = -Math.floor(seconds / 60); }
      return rtf.format(value, unit);
    }

    function typePrefix(type) {
      return type === "news" ? "news" : type === "incident" ? "inc" : "evt";
    }
    function likeKey(type, id) { return `likes_${typePrefix(type)}_${id}`; }
    function likedKey(type, id) { return `liked_${typePrefix(type)}_${id}`; }
    function getLikes(type, id) { return parseInt(localStorage.getItem(likeKey(type, id)) || "0", 10); }
    function isLiked(type, id) { return localStorage.getItem(likedKey(type, id)) === "true"; }
    function setLiked(type, id, liked) {
      localStorage.setItem(likedKey(type, id), liked ? "true" : "false");
      const count = Math.max(0, getLikes(type, id) + (liked ? 1 : -1));
      localStorage.setItem(likeKey(type, id), String(count));
      return count;
    }

    async function loadHomeFeed() {
      try {
        const [newsRes, incRes, evtRes] = await Promise.all([
          fetch("/api/news"),
          fetch("/api/incidents"),
          fetch("/api/events")
        ]);
        const [newsItems, incidentsAll, events] = await Promise.all([
          newsRes.json(),
          incRes.json(),
          evtRes.json()
        ]);

        const incidents = incidentsAll
          .filter(i => (i.status || "").toLowerCase() === "approved")
          .map(i => ({
            type: "incident",
            id: i._id,
            title: i.incidentType,
            description: i.description || "",
            images: Array.isArray(i.images) ? i.images : [],
            time: i.createdAt || Date.now(),
            meta: `Reported by ${i.reporterName}`
          }));

        const news = newsItems.map(n => ({
          type: "news",
          id: n._id,
          title: n.title,
          description: n.description || "",
          images: Array.isArray(n.images) ? n.images : [],
          time: n.createdAt || Date.now(),
          meta: "Official News"
        }));

        const evts = events.map(e => ({
          type: "event",
          id: e._id,
          title: e.title,
          description: e.description || "",
          images: Array.isArray(e.images) ? e.images : [],
          time: e.date || e.createdAt || Date.now(),
          meta: e.date ? `Scheduled ${new Date(e.date).toLocaleDateString()}` : "Event"
        }));

        const combined = [...news, ...incidents, ...evts]
          .sort((a, b) => new Date(b.time) - new Date(a.time))
          .slice(0, 3);

        const feed = document.getElementById("home-feed");
        feed.innerHTML = "";

        if (combined.length === 0) {
          feed.innerHTML = '<li class="post-card">No recent updates.</li>';
          return;
        }

        combined.forEach(item => {
          const liked = isLiked(item.type, item.id);
          const likeCount = getLikes(item.type, item.id);
          const avatar = `https://i.pravatar.cc/80?u=${item.type}_${item.id}`;

          const images = item.images && item.images.length > 0
            ? `
              <div class="post-images ${item.images.length === 1 ? 'single' : ''}">
                ${item.images.map(img => `<img src="${img}" loading="lazy" decoding="async" alt="${item.type} image">`).join("")}
              </div>
            ` : "";

          const li = document.createElement("li");
          li.className = "post-card";
          li.innerHTML = `
            <div class="post-header">
              <img class="avatar" src="${avatar}" alt="Profile">
              <div class="title-wrap">
                <h3>${item.title} <span class="type-badge">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span></h3>
                <span class="meta">${item.meta} ‚Ä¢ ${timeAgo(item.time)}</span>
              </div>
            </div>
            <div class="post-content">
              <p>${item.description}</p>
              ${images}
            </div>
            <div class="post-actions">
              <div class="like-btn ${liked ? 'liked' : ''}" data-type="${item.type}" data-id="${item.id}">
                <span>üëç</span><span class="like-text">${liked ? 'Liked' : 'Like'}</span>
              </div>
              <div class="like-count" data-type="${item.type}" data-id="${item.id}">${likeCount}</div>
            </div>
          `;
          feed.appendChild(li);
        });

        // Delegate like handling (bind once)
        feed.addEventListener("click", (e) => {
          const btn = e.target.closest(".like-btn");
          if (!btn) return;
          const type = btn.getAttribute("data-type");
          const id = btn.getAttribute("data-id");
          const currentlyLiked = isLiked(type, id);
          const newCount = setLiked(type, id, !currentlyLiked);
          btn.classList.toggle("liked", !currentlyLiked);
          btn.querySelector(".like-text").textContent = !currentlyLiked ? "Liked" : "Like";
          const countEl = feed.querySelector(`.like-count[data-type="${type}"][data-id="${id}"]`);
          if (countEl) countEl.textContent = newCount;
        }, { once: true });

        // Notify global search to apply query after feed renders
        window.dispatchEvent(new CustomEvent('feed:loaded', { detail: { page: 'home', count: combined.length } }));
      } catch (err) {
        console.error("Failed to load home feed:", err);
        document.getElementById("home-feed").innerHTML = '<li class="post-card">Failed to load feed.</li>';
        window.dispatchEvent(new CustomEvent('feed:loaded', { detail: { page: 'home', count: 0 } }));
      }
    }

    loadHomeFeed();
  </script>
  <!-- Load navbar partial and then its logic -->
  <script type="module">
    import { initNavbar } from './js/navbar.js';
    fetch('partials/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
        initNavbar();
      })
      .catch(err => console.error('Failed to load navbar:', err));
  </script>
  <script src="js/ui.js"></script>
  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script>
    // Generate QR to open with prefilled "Report Incident" context
    (function generateQR() {
      try {
        const url = new URL(window.location.origin + "/index.html");
        // Pre-fill context: action=report and optional focus on type
        url.searchParams.set("action", "report");
        url.hash = "report-section";
        new QRious({
          element: document.getElementById("qr-code"),
          value: url.toString(),
          size: 160,
          level: "H",
          background: "#fff",
          foreground: "#1877F2"
        });
      } catch (e) {}
    })();
  </script>
  <!-- Inline modal open/close script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const reportBtn = document.getElementById("report-btn");
      const reportModal = document.getElementById("report-modal");
      const closeReportBtn = document.getElementById("close-report");
      const form = document.getElementById("incident-form");

      if (!reportBtn || !reportModal || !closeReportBtn || !form) {
        console.warn("Report modal elements missing");
        return;
      }

      const openModal = () => {
        reportModal.style.display = "flex";
        reportModal.setAttribute("aria-hidden", "false");
        document.body.classList.add("modal-open");
        form.reset();
        // Reset hidden lat/lng inputs
        document.getElementById("lat").value = "";
        document.getElementById("lng").value = "";
        // Reset map view and marker if you have global map/marker variables
        if (window.map && window.marker) {
          window.map.setView([14.4089, 121.0341], 15);
          window.marker.remove();
          window.marker = null;
        }
      };

      const closeModal = () => {
        reportModal.style.display = "none";
        reportModal.setAttribute("aria-hidden", "true");
        document.body.classList.remove("modal-open");
      };

      reportBtn.addEventListener("click", openModal);
      closeReportBtn.addEventListener("click", closeModal);

      // Close modal on clicking outside the form
      reportModal.addEventListener("click", (e) => {
        if (e.target === reportModal) closeModal();
      });

      // Close modal on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && reportModal.style.display === "flex") {
          closeModal();
        }
      });
    });
  </script>
  <script>
    // Datalist fallback for mobile (iOS Safari and browsers without good datalist UI)
    (function datalistFallback() {
      const input = document.getElementById('incidentType');
      const select = document.getElementById('incidentTypeSelect');
      if (!input || !select) return;
      const ua = navigator.userAgent || "";
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      const supportsDataList = !!window.HTMLDataListElement;
      // Treat iOS as not supported and also handle browsers without HTMLDataListElement
      if (isIOS || !supportsDataList) {
        // Show select, hide the datalist input
        select.style.display = 'block';
        input.style.display = 'none';
        // Keep the real form field updated so backend receives incidentType
        select.addEventListener('change', () => { input.value = select.value; });
      }
    })();
  </script>
</body>
</html>
